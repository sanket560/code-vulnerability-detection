"use client";
import React, { useState } from "react";
import Confetti from "react-confetti";

const HeroSection = () => {
  const [phpCode, setPhpCode] = useState('');
  const [vulnerabilityInfo, setVulnerabilityInfo] = useState('');
  const [recommendation, setRecommendation] = useState('');
  const [analysisComplete, setAnalysisComplete] = useState(false);
  const [showConfetti, setShowConfetti] = useState(false);

  const analyzePhpCode = () => {
    const sqlInjectionRegex =
      /(SELECT\s+\*\s+FROM\s+users\s+WHERE\s+username\s*=\s*'.*?'\s+AND\s+password\s*=\s*'.*?')/gi;
    let match;
    let vulnerabilities = [];

    while ((match = sqlInjectionRegex.exec(phpCode)) !== null) {
      const lineNumber =
        (phpCode.substring(0, match.index).match(/\n/g) || []).length + 1;
      const line = phpCode.split("\n")[lineNumber - 1];
      vulnerabilities.push({ line: lineNumber, code: line });
    }

    if (vulnerabilities.length > 0) {
      const vulnerabilityLines = vulnerabilities.map((vuln) => `Line ${vuln.line}: ${vuln.code}`).join("\n");
      const recommendations = 'To prevent SQL injection vulnerabilities, use prepared statements and parameterized queries.';
      setVulnerabilityInfo(vulnerabilityLines);
      setRecommendation(recommendations);
      setShowConfetti(false);
    } else {
      setVulnerabilityInfo("No vulnerabilities found");
      setRecommendation('');
      setShowConfetti(true);
    }

    setAnalysisComplete(true);
  };

  return (
    <div className='md:max-w-7xl mx-auto flex flex-col items-center pt-24'>
      <p className='text-3xl mt-4 font-semibold'>
        Vulnerability Detection for PHP Code
      </p>
      <p className='text-lg mt-3'>
        Our analysis tool will help you identify common security risks in your
        PHP code.
      </p>
      <textarea
        value={phpCode}
        onChange={(e) => setPhpCode(e.target.value)}
        className='md:w-[1000px] w-full px-4 my-10 py-4 rounded-lg border border-gray-300 focus:outline-none h-96'
        placeholder='Paste your code here and rest leave it on us'
      />
      <button
        onClick={analyzePhpCode}
        className='bg-blue-400 text-white py-2 px-3 rounded-md'
      >
        Analyze Code
      </button>
      {analysisComplete && (
        <div className='mt-4'>
          <p
            className={`mb-2 ${
              vulnerabilityInfo.startsWith("Line")
                ? "text-red-600"
                : "text-green-600"
            } font-semibold`}
          >
            {vulnerabilityInfo}
          </p>
          <p className={`mb-2 text-green-600 font-semibold`}>
            {recommendation}
          </p>
          {showConfetti && (
            <Confetti
              width={1400}
              height={1000}
              numberOfPieces={200}
              recycle={false}
            />
          )}
        </div>
      )}
    </div>
  );
};

export default HeroSection;
